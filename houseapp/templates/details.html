{% extends "base.html" %}

{% block content %}

<head>    
  <meta charset="utf-8">    
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">  
  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="text/javascript" src="../static/js/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <style>
    body {
      margin: 0;
      font: 13px/1.5 "Microsoft YaHei", "Helvetica Neue", "Sans-Serif";
      min-height: 960px;
      min-width: 600px;
    }

    .my-map {
      margin: 0 auto;
      width: 800px;
      height: 640px;
    }

    .my-map .icon {
      background: url(//a.amap.com/lbs-dev-yuntu/static/web/image/tools/creater/marker.png) no-repeat;
    }

    .my-map .icon-cir {
      height: 31px;
      width: 28px;
    }

    .my-map .icon-cir-red {
      background-position: -11px -5px;
    }

    .amap-container {
      height: 100%;
    }

    .myinfowindow {
      width: 240px;
      min-height: 50px;
    }

    .myinfowindow h5 {
      height: 20px;
      line-height: 20px;
      overflow: hidden;
      font-size: 14px;
      font-weight: bold;
      width: 220px;
      text-overflow: ellipsis;
      word-break: break-all;
      white-space: nowrap;
    }

    .myinfowindow div {
      margin-top: 10px;
      min-height: 40px;
      line-height: 20px;
      font-size: 13px;
      color: #6f6f6f;
    }
  </style>
</head>

<body>
  <table class="table table-condensed" style="margin-top: 70px; margin-left: 50px;margin-right: 100px; width: 92%;">
    <tr>
      <td rowspan="7" width="50%">
        <div id="myCarousel" class="carousel slide">
          {% if stored_images %}
          <ol class="carousel-indicators">
            {% for l in range(stored_images|length) %}
            {% if l == 0 %}

            <li data-target="#myCarousel" data-slide-to="{{ l }}" class="active"></li>
            {% else %}
            <li data-target="#myCarousel" data-slide-to="{{ l }}"></li>
            {% endif %}
            {% endfor %}
          </ol>
          <div class="carousel-inner">
            {% for i in stored_images [:1]%}
            <div class="item active" style="width: 100%;height: 350px">
              <img src="{{ i.filepath }}" alt="{{ i.filepath }}" style="width: 100%;height: 350px;" class="img-rounded">
            </div>
            {% endfor %}
            {% for i in stored_images [1:]%}
            <div class="item" style="width: 100%;height: 50%;height: 350px;">
              <img src="{{ i.filepath }}" alt="{{ i.filepath }}" style="width: 100%;height: 350px;" class="img-rounded">
            </div>
            {% endfor %}
            {% else %}
            <ol class="carousel-indicators">
              <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
            </ol>
            <div class="carousel-inner">
              <div class="item active" style="width: 100%;height: 350px">
                <img src="{{ url_for('static', filename='img/house4.jpg') }}" alt="house1"
                  style="width: 100%;height: 350px" class="img-rounded">s
              </div>
            </div>
            {% endif %}
            {% if stored_images|length > 1 %}
            <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
              <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
              <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
            {% endif %}
          </div>
        </div>
      </td>
      <td style="vertical-align: top; padding-left: 20px; height: 30%;">
        {% if house.total_price %}
        {% if house.status == 1 %}
        {% if house.user_id == user.id %}
        <span>
          <h2 style="color: red;"><strong>¥ {{ '%.2f' %(house.total_price) }}</strong></h2>
        </span>
        {% endif %}
        {% else %}
        <h2 style="color: red;"><strong>¥ {{ '%.2f' %(house.total_price) }}</strong></h2>
        {% endif %}
        {% else %}
        <h2 style="color: red;"><strong>Pending</strong></h2>
        {% endif %}
        {% if house.total_price %}
        <p style="color: darkgray; font-size: 15px;">¥ {{ '%.2f' %(house.total_price / house.square) }}</p>
        {% else %}
        <p style="color: darkgray; font-size: 15px;">Pending</p>
        {% endif %}
      </td>
      {% if house.total_price %}
      {% if house.status == 1 %}
      {% if house.user_id == user.id %}
      <td style="vertical-align: middle;" align="right">
        <a href="{{ url_for('edit_house',house_id=house.id) }}"><button class="btn btn-defult" type="button"
            name="button" style="margin-right: 10px;"><span class="glyphicon glyphicon-edit"
              style="padding-top: 3px;"></span>&nbsp;Edit</button></a>
        {% if stored_images %}
        <a><button class="btn btn-defult" type="button" name="button" data-toggle="modal" data-target="#upload"><span
              class="glyphicon glyphicon-cloud-upload" style="padding-top: 3px;"></span>&nbsp;Upload</button></a>
        {% else %}
        <a><button class="btn btn-defult" type="button" name="button" data-toggle="modal"
            data-target="#need_picture"><span class="glyphicon glyphicon-cloud-upload"
              style="padding-top: 3px;"></span>&nbsp;Upload</button></a>
        {% endif %}

      </td>
      <div class="modal fade" id="upload" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                &times;
              </button>
              <h4 class="modal-title" id="myModalLabel">
                Are you sure to upload?
              </h4>
            </div>
            <div class="modal-body">
              You will upload the house with id:&nbsp;<b>{{ house.id }}</b>.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">No
              </button>
              <a href="{{ url_for('upload_house',house_id1=house.id) }}"><button type="button"
                  class="btn btn-success btn-sm">Yes
                </button></a>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="need_picture" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                &times;
              </button>
              <h4 class="modal-title" id="myModalLabel">
                Go to upload your picture!
              </h4>
            </div>
            <div class="modal-body">
              You should upload at least one picture of the house.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Cancel
              </button>
              <a href="{{ url_for('edit_house',house_id=house.id) }}"><button type="button"
                  class="btn btn-success btn-sm">Go To Edit
                </button></a>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      {% elif house.status == 2 %}
      {% if user %}
      {% if house.user_id == user.id %}
      <td style="vertical-align: middle;" align="right">
        <a href="{{ url_for('edit_house',house_id=house.id) }}"><button class="btn btn-defult" type="button"
            name="button"><span class="glyphicon glyphicon-edit"
              style="padding-top: 3px;"></span>&nbsp;Edit</button></a>
      </td>
      {% endif %}
      {% endif %}
      {% endif %}
      {% if user %}
      {% if not house.user_id == user.id %}
      {% if favorite %}
      <td style="vertical-align: top;" align="right">
        <a href="{{ url_for('remove_favorite',house_id2=house.id, user_id2=user.id) }}"><button
            class="btn btn-danger btn-xs" type="button" name="button" style="margin-top: 5px;"><span
              class="glyphicon glyphicon-star" style="padding-top: 3px;"></span>&nbsp;Remove from Favorite </button></a>
      </td>
      {% else %}
      <td style="vertical-align: top;" align="right">
        <a href="{{ url_for('add_to_favorite',house_id2=house.id, user_id2=user.id) }}"><button
            class="btn btn-warning btn-xs" type="button" name="button" style="margin-top: 5px;"><span
              class="glyphicon glyphicon-star-empty" style="padding-top: 3px;"></span>&nbsp;Add to Favorite
          </button></a>
      </td>
      {% endif %}
      {% endif %}
      {% endif %}
      {% endif %}
    </tr>
    {% if user %}
    <tr class="active">
      <td style="padding-left: 20px;vertical-align: middle;">Estimated monthly loan:</td>
      <td width="20%" style="vertical-align: middle;"><b>¥ {{ '%.2f' %(money_calculate[1]) }}&nbsp;&nbsp;<button
            class="btn btn-link btn-xs" onclick="calculation()"><span
              class="glyphicon glyphicon-info-sign"></span>&nbsp;More precise?</button></b></td>
    </tr>
    {% endif %}
    <tr>
      <td style="padding-left: 20px;vertical-align: middle;">Building Type:</td>
      {% if house.building_type == 1 %}
      <td width="20%" style="vertical-align: middle;"><b>Tower</b></td>
      {% elif house.building_type == 2 %}
      <td width="20%" style="vertical-align: middle;"><b>Bungalow</b></td>
      {% elif house.building_type == 3 %}
      <td width="20%" style="vertical-align: middle;"><b>Plate & Tower</b></td>
      {% elif house.building_type == 4 %}
      <td width="20%" style="vertical-align: middle;"><b>Plate</b></td>
      {% endif %}
    </tr>

    <tr class="active">
      <td style="padding-left: 20px;vertical-align: middle;">Square:</td>
      <td width="20%" style="vertical-align: middle;"><b>{{ house.square }} sq metres</b></td>
    </tr>
    <tr>
      <td style="padding-left: 20px;vertical-align: middle;">Floor:</td>
      <td width="20%" style="vertical-align: middle;"><b>{{ house.floor }}</b></td>
    </tr>

    <tr class="active">
      <td style="padding-left: 20px;vertical-align: middle;">Renovation Type:</td>
      {% if house.renovation_con == 1 %}
      <td width="20%" style="vertical-align: middle;"><b>Other</b></td>
      {% elif house.renovation_con == 2 %}
      <td width="20%" style="vertical-align: middle;"><b>Rough</b></td>
      {% elif house.renovation_con == 3 %}
      <td width="20%" style="vertical-align: middle;"><b>Simplicity</b></td>
      {% elif house.renovation_con == 4 %}
      <td width="20%" style="vertical-align: middle;"><b>Hardcover</b></td>
      {% endif %}
    </tr>

    <tr>
      <td style="padding-left: 20px;vertical-align: middle;">District:</td>
      {% if house.district == 1 %}
      <td width="20%" style="vertical-align: middle;"><b>DongCheng</b></td>
      {% elif house.district == 2 %}
      <td width="20%" style="vertical-align: middle;"><b>FengTai</b></td>
      {% elif house.district == 3 %}
      <td width="20%" style="vertical-align: middle;"><b>TongZhou</b></td>
      {% elif house.district == 4 %}
      <td width="20%" style="vertical-align: middle;"><b>DaXing</b></td>
      {% elif house.district == 5 %}
      <td width="20%" style="vertical-align: middle;"><b>FangShan</b></td>
      {% elif house.district == 6 %}
      <td width="20%" style="vertical-align: middle;"><b>ChangPing</b></td>
      {% elif house.district == 7 %}
      <td width="20%" style="vertical-align: middle;"><b>ChaoYang</b></td>
      {% elif house.district == 8 %}
      <td width="20%" style="vertical-align: middle;"><b>HaiDian</b></td>
      {% elif house.district == 9 %}
      <td width="20%" style="vertical-align: middle;"><b>XiCheng</b></td>
      {% elif house.district == 10 %}
      <td width="20%" style="vertical-align: middle;"><b>ShiJingShan</b></td>
      {% elif house.district == 11 %}
      <td width="20%" style="vertical-align: middle;"><b>PingGu</b></td>
      {% elif house.district == 12 %}
      <td width="20%" style="vertical-align: middle;"><b>MenTouGou</b></td>
      {% elif house.district == 13 %}
      <td width="20%" style="vertical-align: middle;"><b>ShunYi</b></td>
      {% endif %}
    </tr>

  </table>
  <div style="margin: 30px 50px 30px 50px;">
    <div class="panel-group" id="accordion">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#details">
              <b style="font-size:3rem;">Details</b>
            </a>
          </h4>
        </div>
        <div id="details" class="panel-collapse collapse in">
          <div class="panel-body">
            <table class="table">
              <tr>
                <td style="padding-left: 20px;vertical-align: middle;">Total Price:</td>
                {% if house.total_price %}
                <td width="20%" style="vertical-align: middle;"><b>¥ {{ house.total_price }}</b></td>
                {% else %}
                <td width="20%" style="vertical-align: middle;"><b>Pending</b></td>
                {% endif %}
                <td rowspan="12" width="50%" align="center" style="border: 0rem;vertical-align: middle;">
                  {% if house.square < 100 %}
                  <img src="{{ url_for('static', filename='img/house-inside/4.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 100 and house.square < 110 %}
                  <img src="{{ url_for('static', filename='img/house-inside/1.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 110 and house.square < 120 %}
                  <img src="{{ url_for('static', filename='img/house-inside/2.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 120 and house.square < 130 %}
                  <img src="{{ url_for('static', filename='img/house-inside/3.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 130 and house.square < 150 %}
                  <img src="{{ url_for('static', filename='img/house-inside/5.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 150 and house.square < 170 %}
                  <img src="{{ url_for('static', filename='img/house-inside/6.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 170 and house.square < 200 %}
                  <img src="{{ url_for('static', filename='img/house-inside/7.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 200 and house.square < 230 %}
                  <img src="{{ url_for('static', filename='img/house-inside/8.png') }}" alt="house_inside" width="80%">
                  {% elif house.square >= 230%}
                  <img src="{{ url_for('static', filename='img/house-inside/9.png') }}" alt="house_inside" width="80%">
                  {% endif %}
                </td>
              </tr>
              <tr class="active">
                <td style="padding-left: 20px;vertical-align: middle;">Price:</td>
                {% if house.total_price %}
                <td width="20%" style="vertical-align: middle;"><b>¥ {{ '%.2f' %(house.total_price / house.square)
                    }}</b></td>
                {% else %}
                <td width="20%" style="vertical-align: middle;"><b>Pending</b></td>
                {% endif %}
              </tr>
              <tr>
                <td style="padding-left: 20px;vertical-align: middle;">Square:</td>
                <td width="20%" style="vertical-align: middle;"><b>{{ house.square }}</b></td>
              </tr>
              <tr class="active">
                <td style="padding-left: 20px;vertical-align: middle;">Livingroom:</td>
                <td width="20%" style="vertical-align: middle;"><b>{{ house.living_room }}</b></td>
              </tr>
              <tr>
                <td style="padding-left: 20px;vertical-align: middle;">Drawingroom:</td>
                <td width="20%" style="vertical-align: middle;"><b>{{ house.drawing_room }}</b></td>
              </tr>
              <tr class="active">
                <td style="padding-left: 20px;vertical-align: middle;">Kitchen:</td>
                <td width="20%" style="vertical-align: middle;"><b>{{ house.kitchen }}</b></td>
              </tr>
              <tr>
                <td style="padding-left: 20px;vertical-align: middle;">Bathroom:</td>
                <td width="20%" style="vertical-align: middle;"><b>{{ house.bathroom }}</b></td>
              </tr>
              <tr class="active">
                <td style="padding-left: 20px;vertical-align: middle;">Floor:</td>
                <td width="20%" style="vertical-align: middle;"><b>{{ house.floor }}</b></td>
              </tr>
              <tr>
                <td style="padding-left: 20px;vertical-align: middle;">Elevator: </td>
                {% if house.elevator == 1 %}
                <td width="20%" style="vertical-align: middle;"><b>Available</b></td>
                {% elif house.elevator == 0 %}
                <td width="20%" style="vertical-align: middle;"><b>Not Available</b></td>
                {% endif %}
              </tr>
              <tr class="active">
                <td style="padding-left: 20px;vertical-align: middle;">Subway: </td>
                {% if house.subway == 1 %}
                <td width="20%" style="vertical-align: middle;"><b>Available</b></td>
                {% elif house.subway == 0 %}
                <td width="20%" style="vertical-align: middle;"><b>Not Available</b></td>
                {% endif %}
              </tr>

              <tr>
                <td style="padding-left: 20px;vertical-align: middle;">Building Type:</td>
                {% if house.building_type == 1 %}
                <td width="20%" style="vertical-align: middle;"><b>Tower</b></td>
                {% elif house.building_type == 2 %}
                <td width="20%" style="vertical-align: middle;"><b>Bungalow</b></td>
                {% elif house.building_type == 3 %}
                <td width="20%" style="vertical-align: middle;"><b>Plate & Tower</b></td>
                {% elif house.building_type == 4 %}
                <td width="20%" style="vertical-align: middle;"><b>Plate</b></td>
                {% endif %}
              </tr>

              <tr class="active">
                <td style="padding-left: 20px;vertical-align: middle;">Renovation Type:</td>
                {% if house.renovation_con == 1 %}
                <td width="20%" style="vertical-align: middle;"><b>Other</b></td>
                {% elif house.renovation_con == 2 %}
                <td width="20%" style="vertical-align: middle;"><b>Rough</b></td>
                {% elif house.renovation_con == 3 %}
                <td width="20%" style="vertical-align: middle;"><b>Simplicity</b></td>
                {% elif house.renovation_con == 4 %}
                <td width="20%" style="vertical-align: middle;"><b>Hardcover</b></td>
                {% endif %}
              </tr>

            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="panel-group" id="accordion">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#recommendation">
              <b style="font-size:3rem;">Recommendation</b>
            </a>
          </h4>
        </div>
        <div id="recommendation" class="panel-collapse collapse in">
          {% if stored_recomm %}
          <div class="panel-body">

            <p style="margin-left: 15px;">{{ stored_recomm.reason }}</p>

          </div>
          {% else %}
          <div class="panel-body">
            <p style="margin: 10px 0 0 15px;color: gray;">The seller hasn't released any recommendation yet.</p>
          </div>
          {% endif %}
          <div id="contact" style="margin-left: 30px;margin-right: 30px;margin-top: 10px;">
            <p style="font-size: large;"><b>Contact Agent</b></p>
            <hr>
            <table width="60%" style="margin-bottom: 30px;">
              <tr>
                <td width="20%" style="color:steelblue;"><span class="glyphicon glyphicon-user"></span><b><a
                      href="{{ url_for('visitothers', user_id=owner.id) }}">&nbsp;&nbsp;&nbsp;{{ owner.username
                      }}</b></a></td>
                <td style="color:steelblue"><span class="glyphicon glyphicon-envelope"></span><b>&nbsp;&nbsp;&nbsp;{{
                    owner.email }}</b></td>
              </tr>
            </table>
          </div>

        </div>
      </div>
    </div>
    {% if house.status==2 %}
    {% if user %}
    <div class="panel-group" id="accordion">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#location">
              <b style="font-size:3rem;">Location</b>
            </a>
          </h4>
        </div>
        <div id="location" class="panel-collapse collapse in">
          <div id="wrap" class="my-map" style="margin: 35px 20px 0px 20px;">
            <!-- <h3>Lng: {{ house.lng }}; Lat: {{ house.lat }}</h3> -->
            <div id="mapContainer" style="width:140%;height:600px"></div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% endif %}
    {% if house.status == 2 %}
    <div id="loan_calculation">
      <div class="panel-group" id="accordion">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#loan">
                <b style="font-size:3rem;">Loan Calculation</b>
              </a>
            </h4>
          </div>
          <div id="loan" class="panel-collapse collapse in">
            {% if user %}
            <form action="" method="post" novalidate style="margin-left: 10px; margin-right: 10px;margin-bottom: 20px;">
              {{ form4.hidden_tag() }}
              <table style="width:100%;">
                <tr>
                  <td style="width: 45%;">
                    <div class="input-group" style="margin-top: 20px;padding-left: 10px;padding-right: 10px;">
                      <span class="input-group-addon">Loan Type</span>
                      {{ form4.money_type(class="form-control") }}
                    </div>
                  </td>
                  <td style="width: 45%;">
                    <div class="input-group" style="margin-top: 20px;padding-left: 10px;padding-right: 10px;">
                      <span class="input-group-addon">Number of House</span>
                      {{ form4.house_number(class="form-control") }}
                    </div>
                  </td>
                  <td rowspan="2" style="width:10%">{{ form4.calculate(class="button",
                    style="height:85px;margin-top:20px;") }}</td>

                </tr>
                <tr>
                  <td>
                    <div class="input-group" style="margin-top: 20px;padding-left: 10px;padding-right: 10px;">
                      <span class="input-group-addon">Price Percentage</span>
                      {{ form4.price(class="form-control") }}
                    </div>
                  </td>
                  <td>
                    <div class="input-group" style="margin-top: 20px;padding-left: 10px;padding-right: 10px;">
                      <span class="input-group-addon">Loan Months</span>
                      {{ form4.month(class="form-control") }}
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div id="container" style="min-width:400px;height:400px;margin-top: 10px;"></div>
                  </td>

                  <td colspan="2">
                    <table class="table table-hover" style="margin:0 10px 0 10px;width: 95%;">
                      <tr>
                        <td><b>Loan Type</b></td>
                        {% if money.money_type == 1 %}
                        <td>Commercial Loans</td>
                        {% elif money.money_type == 2 %}
                        <td>Housing Provident Fund Loans</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <td><b>Number of House</b></td>
                        {% if money.house_number == 1 %}
                        <td>First House Loan</td>
                        {% elif money.house_number == 2 %}
                        <td>Second House Loan</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <td><b>Price Percentage</b></td>
                        <td>{{ money.price_percentage }}0%</td>
                      </tr>
                      <tr>
                        <td><b>Loan Months</b></td>
                        <td>{{ money.month*12 }} months</td>
                      </tr>
                      <tr>
                        <td><b>Down Payment</b></td>
                        <td>¥ {{ '%.2f' %(money_calculate[0]) }}</td>
                      </tr>
                      <tr>
                        <td><b>Monthly Repayment</b></td>
                        <td>¥ {{ '%.2f' %(money_calculate[1]) }}</td>
                      </tr>
                      <tr>
                        <td><b>Total Interest</b></td>
                        <td>¥ {{ '%.2f' %(money_calculate[2]) }}</td>
                      </tr>
                      <tr>
                        <td><b>Total Repayment</b></td>
                        <td>¥ {{ '%.2f' %(money_calculate[4]) }}</td>
                      </tr>
                      <tr>
                        {% if money.error_type == 0 %}
                        <td colspan="2" style="font-size: 13px;color: gray;">
                          <span class="glyphicon glyphicon-ok-sign" style="color: lightgreen;"></span>&nbsp;The loan is
                          under the law :) <br>
                          &nbsp;&nbsp;&nbsp;&nbsp; See your loan according to the table above!
                        </td>
                        {% elif money.error_type == 1 %}
                        <td colspan="2" style="font-size: 13px;color: gray;">
                          <span class="glyphicon glyphicon-remove-sign" style="color: lightcoral;"></span>&nbsp;The loan
                          isn't under the law :( <br> &nbsp;&nbsp;&nbsp;&nbsp; Using Commercial Loans to buy the first
                          house can only borrow <b>70%</b> at most. It has been automatically changed for you, please
                          refer to the above table.
                        </td>
                        {% elif money.error_type == 2 %}
                        <td colspan="2" style="font-size: 13px;color: gray;">
                          <span class="glyphicon glyphicon-remove-sign" style="color: lightcoral;"></span>&nbsp;The loan
                          isn't under the law :( <br> &nbsp;&nbsp;&nbsp;&nbsp; Using Commercial Loans to buy the second
                          house can only borrow <b>30%</b> at most. It has been automatically changed for you, please
                          refer to the above table.
                        </td>
                        {% elif money.error_type == 3 %}
                        <td colspan="2" style="font-size: 13px;color: gray;">
                          <span class="glyphicon glyphicon-remove-sign" style="color: lightcoral;"></span>&nbsp;The loan
                          isn't under the law :( <br> &nbsp;&nbsp;&nbsp;&nbsp; Using Housing Provident Fund Loans to buy
                          the second house can only borrow <b>40%</b> at most. It has been automatically changed for
                          you, please refer to the above table.
                        </td>
                        {% else %}
                        <td colspan="2" style="font-size: 13px;color: gray;">
                          <span class="glyphicon glyphicon-ok-sign" style="color: lightgreen;"></span>&nbsp;The loan is
                          under the law :) <br>
                          &nbsp;&nbsp;&nbsp;&nbsp; See your loan according to the table above!
                        </td>
                        {% endif %}
                        {% else %}
                        <div style="margin:40px 30px 40px 30px;">
              <p style="color: red; "><b>You have to log in to calculate loan.</b></p><br>
              <p><span>Already have an account?</span>
                <a href="{{ url_for('login') }}"><span class="glyphicon glyphicon-user"></span> Log in</a>
              </p><br>
              <p><span>Create an account? </span>
                <a href="{{ url_for('signup') }}"><span class="glyphicon glyphicon-user"></span> Register</a>
              </p></div>
                        {% endif %}
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="panel-group" id="accordion" style="margin-top: 20px;">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#comments">
              <b style="font-size:3rem;">Comments</b>
            </a>
          </h4>
        </div>
        <div id="comments" class="panel-collapse collapse in">
          <div class="panel-body">
            <table style="margin-left: 20px; margin-right: 20px;width: 100%;">
              {% if comments %}
              {% for c in comments %}
              <tr>
                {% if c.user_id == owner.id %}
                <td width="9%" style="vertical-align: top;padding-top: 13px;"><span
                    class="glyphicon glyphicon-user"></span><a
                    href="{{ url_for('visitothers', user_id=c.user_id) }}"><b>&nbsp;&nbsp;{{ authors[c.id].username }}</b><span
                      class="label label-warning" style="margin-left: 7px;vertical-align: middle;">owner</span></a></td>
                {% else %}
                <td width="9%" style="vertical-align: top;padding-top: 13px;"><span
                    class="glyphicon glyphicon-user"></span><a href="{{ url_for('visitothers', user_id=c.user_id) }}"
                    <b>&nbsp;&nbsp;{{ authors[c.id].username }}</b><span class="label label-info"
                      style="margin-left: 7px;vertical-align: middle;">user</a></span>
                </td>
                {% endif %}
                <td class="comment">{{ c.body }}
                  <a href="{{ url_for('details', house_id=house.id, comment_id=c.id, reply=True)}}">
                    <button type="button" name="button" id="reply_btn" class="btn btn-default btn-xs">Reply</button>
                  </a>
                  {% if answers[c.id] %}
                  <ul>
                    {% for a in answers[c.id] %}
                    <li>User <a href="{{ url_for('visitothers', user_id=a.user_id) }}">{{ a.user_id }}</a> said: {{
                      a.body }}</li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <div class="panel-body">
                <p style="margin: 10px 0 0 10px;color: gray;">No comment yet.</p>
              </div>
              {% endif %}
            </table>
            <hr style="margin-right: 20px;margin-left: 20px;">
            <div class="panel-body">
              {% if user %}
              {% if reply %}
              <!-- reply function -->
              <!-- <div id="reply_form" style="display:none"> -->
              <div>
                <form action="" method="post" novalidate style="margin-right: 30px;">
                  {{ form3.hidden_tag() }}
                  <p>
                    {{ form3.comment.label }}<br>
                    {{ form3.comment(rows=8, cols=80, class="form-control",placeholder="Replying") }}

                    {% for error in form3.comment.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                  </p>
                  <p align="right">{{ form3.submit(class="btn btn-defult") }}</p>
              </div>

              {% else %}
              <!-- comment function  -->
              <div id="comment_form">
                <form action="" method="post" novalidate>
                  {{ form.hidden_tag() }}
                  <p>
                    {{ form.comment.label }}<br>
                    {{ form.comment(rows=8, cols=80, class="form-control") }}

                    {% for error in form.comment.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                    {% endfor %}
                  </p>
                  <p align="right">{{ form.submit(class="btn btn-defult") }}</p>
              </div>
              {% endif %}
              {% else %}
              <p style="color: red; "><b>You have to log in to comment.</b></p><br>
              <p><span>Already have an account?</span>
                <a href="{{ url_for('login') }}"><span class="glyphicon glyphicon-user"></span> Log in</a>
              </p><br>
              <p><span>Create an account? </span>
                <a href="{{ url_for('signup') }}"><span class="glyphicon glyphicon-user"></span> Register</a>
              </p>
              {% endif %}
            </div>
            
          </div>
        </div>
      </div>
    </div>
    


    {% if house.status == 2 %}
    <div class="panel-group" id="accordion" style="margin-top: 20px;margin-bottom: 30px;">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#like">
              <b style="font-size:3rem;">Users who like this house also like...</b>
            </a>
          </h4>
        </div>
        <div id="like" class="panel-collapse collapse in">
          {% if re_houses|length != 0 %}
          {% for h in re_houses %}
          <table class="table table-condensed" style="width: 95%;margin:10px 20px 10px 20px">
            <tr>
              {% for i in imgs_re %}
              {% if i.house_id == h.id %}
              <td rowspan="4" style="width: 22%;">
                <a href="{{ url_for('details', house_id=h.id )}}" id="image"><img
                    src="{{ i.filepath }}" alt="{{ i.filepath }}" width="230px" height="170px" class="img-rounded"></a>
              </td>
              {% endif %}
              {% endfor %}
              {% if h.status == 2 %}
              {% if h.building_type == 1 %}
              <td colspan="2" class="active"
                style="vertical-align: middle;padding-left: 25px;width: 26%;font-size: 20px;"><strong>Type:
                  Tower</strong></td>
              {% elif h.building_type == 2 %}
              <td colspan="2" class="active"
                style="vertical-align: middle;padding-left: 25px;width: 26%;font-size: 20px;"><strong>Type:
                  Bungalow</strong></td>
              {% elif h.building_type == 3 %}
              <td colspan="2" class="active"
                style="vertical-align: middle;padding-left: 25px;width: 26%;font-size: 20px;"><strong>Type: Plate &
                  Tower</strong></td>
              {% elif h.building_type == 4 %}
              <td colspan="2" class="active"
                style="vertical-align: middle;padding-left: 25px;width: 26%;font-size: 20px;"><strong>Type:
                  Plate</strong></td>
              {% endif %}
              {% if h.renovation_con == 1 %}
              <td colspan="2" class="active"
                style="vertical-align: middle; padding-left: 25px;width: 26%;font-size: 20px;"><b>Renovation: Other</b>
              </td>
              {% elif h.renovation_con == 2 %}
              <td colspan="2" class="active"
                style="vertical-align: middle; padding-left: 25px;width: 26%;font-size: 20px;"><b>Renovation: Rough</b>
              </td>
              {% elif h.renovation_con == 3 %}
              <td colspan="2" class="active"
                style="vertical-align: middle; padding-left: 25px;width: 26%;font-size: 20px;"><b>Renovation:
                  Simplicity</b></td>
              {% elif h.renovation_con == 4 %}
              <td colspan="2" class="active"
                style="vertical-align: middle; padding-left: 25px;width: 26%;font-size: 20px;"><b>Renovation:
                  Hardcover</b></td>
              {% endif %}
              <td rowspan="3" align="center" style="font-size: 25px;width: 26%;">
                <div
                  style="background-color: rgb(240, 240, 240);border: 1px solid rgb(240, 240, 240);
            border-radius: 10px;vertical-align: middle;box-shadow: 5px 5px 5px rgb(172, 172, 172);margin: 45px 50px 0 50px; height:100%;padding-top: 10px;padding-bottom: 10px;">
                  <b> <strong style="color: red;">
                      ¥{{ '%.2f' %(h.total_price) }}</strong></b>
                  <br>
                  <p style="color:grey;font-size: 13px;">¥{{ '%.2f' %(h.total_price/h.square) }}/m<sup>2</sup></p>
                </div>


              </td>
            </tr>
            <tr>
              <td style="padding-left: 25px;width: 13%;vertical-align: middle;">
                <b><span class="glyphicon glyphicon-home"></span>&nbsp;&nbsp;{{ h.living_room }} Beds</b>
              </td>
              <td style="padding-left: 25px;width: 13%;vertical-align: middle;">
                <b><img src="{{ url_for('static', filename='img/drawingroom.png') }}" alt="drawing_room" width="18%"
                    style="padding-bottom: 3px;" />&nbsp;{{ h.drawing_room }} Parlour</b>
              </td>
              <td style="padding-left: 25px;width: 13%;vertical-align: middle;">
                <b><span class="glyphicon glyphicon-cutlery"></span>&nbsp;&nbsp;{{ h.kitchen }} Kitchen</b>
              </td>
              <td style="padding-left: 25px;width: 13%;vertical-align: middle;">
                <b><img src="{{ url_for('static', filename='img/bathroom.png') }}" alt="house2" width="18%"
                    style="padding-bottom: 3px;" />&nbsp;{{ h.bathroom }} Baths</b>
              </td>
            </tr>
            <tr>
              {% if h.elevator == 1 %}
              <td style="vertical-align: middle;padding:7px 0 7px 25px"><span class="glyphicon glyphicon-ok-sign"
                  style="color: rgb(24, 177, 24);"></span>&nbsp;<b>Elevator</b></td>
              {% elif h.elevator == 0 %}
              <td style="vertical-align: middle;padding:5px 0 5px 25px"><span class="glyphicon glyphicon-remove-sign"
                  style="color: rgb(221, 0, 0);"></span>&nbsp;<b>Elevator</b></td>
              {% endif %}
              {% if h.subway == 1 %}
              <td style="vertical-align: middle;padding:5px 0 5px 25px"><span class="glyphicon glyphicon-ok-sign"
                  style="color: rgb(24, 177, 24);"></span>&nbsp;<b>Subway</b></td>
              {% elif h.subway == 0 %}
              <td style="vertical-align: middle;padding:5px 0 5px 25px"><span class="glyphicon glyphicon-remove-sign"
                  style="color: rgb(221, 0, 0);"></span>&nbsp;<b>Subway</b></td>
              {% endif %}
              <td colspan="2" style="vertical-align: middle;padding:5px 0 5px 25px"><b><span
                    class="glyphicon glyphicon-fullscreen"></span>&nbsp;{{ h.square }}m<sup>2</sup></b></td>
            </tr>
            {% endif %}
          </table>
          {% endfor %}
          {% else %}
          <p style="color: gray;font-size: 13px;margin: 20px;">No such house found :(</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  <div class="lb_gl">
    <h1 class="title" style="color: rgb(0, 0, 0);"><b><span
          class="glyphicon glyphicon-align-right"></span>&nbsp;&nbsp;Popular Houses&nbsp;&nbsp;<span
          class="glyphicon glyphicon-align-left"></span></b></h1>
    <div class="container">
      <div class="pictureSlider poster-main">
        <div class="poster-btn poster-prev-btn"></div>
        <div id="zturn" class="poster-list">
          {% for h in pop_houses %}
          <div class="poster-item  zturn-item">
            <p class="houseid">House ID: {{ h.id }}</p>
            <div class="for_btn">
              <a href="{{ url_for('details', house_id=h.id )}}" id="image">
                {% for i in imgs %}
                {% if i.house_id == h.id %}
                <img src="{{ i.filepath }}" alt="{{ i.filepath }}" width="100%" height="190px">
                {% endif %}
                {% endfor %}
              </a>
            </div>

            <div class="property">
              <p class="pro">Total Price：<span class="per">¥ {{ '%.2f' %(h.total_price) }}</span>
              </p>
              <p class="pro"><span>Square：<span class="per">{{ h.square }} m<sup>2</sup></span></span>
              </p>
              <div class="recommendation">
                {% for r in recommendations %}
                {% if r.house_id == h.id %}
                {{ r.reason }}
                {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
 
</body>
<style>
  .comment {
    background-color: rgb(235, 235, 235);
    padding: 5px 8px;
    display: inline-block;
    border-radius: 4px;
    margin: 10px 0 10px 10px;
    position: relative;

  }

  .comment::after {
    content: '';
    border: 8px solid #ffffff00;
    border-right: 8px solid rgb(235, 235, 235);
    position: absolute;
    top: 6px;
    left: -16px;
  }

  .button {
    border: none;
    color: white;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 18px;
    -webkit-transition-duration: 0.4s;
    /* Safari */
    transition-duration: 0.4s;
    cursor: pointer;
    background-color: #434348;
    color: #ffffff;
    border: 2px solid #434348;
  }

  .button:hover {
    background-color: #ffffff;
    color: #434348;
  }

  .lb_gl {
    margin-top: 30px;
    background-size: 100% 100%;
    height: 80%;
    background-image: linear-gradient(#ffffff, #797979, #ffffff);
  }

  .container {
    width: 100%;
    position: relative;
  }

  .pictureSlider {
    height: 80%;
  }

  .poster-item {
    background: #fff;
    margin-top: 20px;
    height: 80%;
    width: 336px;
    border-radius: 10px;
    padding: 20px 23px 20px 23px;
    border: 3px dotted #bebebe;
    transition: all 0.5s;
    cursor: default;
    -moz-transition: all 0.5s;
    cursor: default;
    -webkit-transition: all 0.5s;
    cursor: default;
    -o-transition: all 0.5s;
    cursor: default;
  }

  .title {
    text-align: center;
    color: #000000;
    font-weight: 400;
    font-size: 36px;
    padding: 40px 10px;
  }

  .houseid {
    font-size: 30px;
    font-weight: 900;
    padding-left: 10px;
  }

  .pro {
    margin-bottom: 20px;
    color: #999;
    font-size: 18px;
    overflow: hidden;
  }

  .per {
    color: #000;
    padding-left: 10px;
  }

  .recommendation {
    border-top: 1px solid #d0cddb;
    line-height: 26px;
    padding-top: 5px;
    color: #999;
    font-size: 12px;
    max-height: 84px;
    overflow: hidden;
  }

  .for_btn {
    position: relative;
    height: 214px;
    overflow: hidden
  }

  .in_page {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 40px;
    height: 40px;
    margin-left: -20px;
    margin-top: -20px;
  }

  .in_page>img {
    width: 40px;
    height: 40px;
  }

  .check_more {
    width: 180px;
    height: 50px;
    line-height: 50px;
    text-align: center;
    color: #fff;
    background: #bc241d;
    margin: 0 auto;
    display: block;
  }
</style>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=您申请的key值&plugin=AMap.Geocoder"></script>
<script src="https://code.highcharts.com.cn/highcharts/highcharts.js"></script>
<script src="https://code.highcharts.com.cn/highcharts/modules/exporting.js"></script>
<script src="https://img.hcharts.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
<script>
  var zturn = function (turn) {
    this.turn = turn
    this.zturn = $("#" + turn.id)
    this.X = 0
    this.zturnitem = this.zturn.children(".zturn-item")
    this.num_li = this.zturnitem.length//轮播元素个数 zturnPy为每个的偏移量
    this.zturnPy = turn.Awidth / (this.num_li - 1)
    this.init()
    this.turn_()
    return this
  }
  zturn.prototype = {
    constructor: zturn,
    init: function () {
      var _self = this;
      this.zturn.children(".zturn-item").each(function (index, element) {
        //index是第几个元素 X是选取的中间数 num_li是总数
        var rt = 1//1:右侧：-1：左侧
        if ((index - _self.X) > _self.num_li / 2 || (index - _self.X) < 0 && (index - _self.X) > (-_self.num_li / 2)) { rt = -1 }//判断元素左侧还是右侧
        var i = Math.abs(index - _self.X);//取绝对值
        if (i > _self.num_li / 2) { i = parseInt(_self.X) + parseInt(_self.num_li) - index; }//i:是左或者右的第几个
        if ((index - _self.X) < (-_self.num_li / 2)) { i = _self.num_li + index - _self.X }
        $(this).css({
          'position': 'absolute',
          'left': '50%',
          'margin-left': -_self.turn.width / 2 + 23 + _self.zturnPy * rt * i + "px",
          'z-index': _self.num_li - i,
          'opacity': Math.pow(_self.turn.opacity, i),
          'transform': 'scale(' + Math.pow(_self.turn.scale, i) + ')',
          '-webkit-transform': 'scale(' + Math.pow(_self.turn.scale, i) + ')',
          '-webkit-transform': 'scale(' + Math.pow(_self.turn.scale, i) + ')',
          '-moz-transform': 'scale(' + Math.pow(_self.turn.scale, i) + ')',
          '-ms-transform': 'scale(' + Math.pow(_self.turn.scale, i) + ')',
          '-o-transform': 'scale(' + Math.pow(_self.turn.scale, i) + ')'
        })
        $(this).attr("data_n", index)
      })
    },
    turn_: function () {
      var _self = this
      this.zturnitem.click(function () {
        _self.X = $(this).attr("data_n")
        _self.init()
      })
    },
    prev_: function () {
      var _self = this
      this.X--
      if (this.X < 0) { this.X = this.num_li - 1 }
      this.init()
    },
    next_: function () {
      var _self = this
      this.X++
      if (this.X >= this.num_li) { this.X = 0 }
      this.init()
    }
  }
  var aa = new zturn({
    id: "zturn",
    opacity: 0.9,
    width: 382,
    Awidth: 1024,
    scale: 0.9
  })
  var ab = new zturn({
    id: "zturn2",
    opacity: 0.8,
    width: 382,
    Awidth: 1024,
    scale: 0.6
  })
  Highcharts.chart('container', {
    chart: {
      plotBackgroundColor: null,
      plotBorderWidth: null,
      plotShadow: false,
      type: 'pie'
    },
    title: {
      text: 'Down payment, Principal, Interest'
    },
    tooltip: {
      pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },
    credits: {
      enabled: false
    },

    exporting: {
      enabled: false
    },
    plotOptions: {
      pie: {
        allowPointSelect: true,
        cursor: 'pointer',
        dataLabels: {
          enabled: false
        },
        showInLegend: true
      }
    },
    series: [{
      name: 'Percentage',
      colorByPoint: true,
      data: [{
        name: 'Down payment',
        y: parseFloat("{{ money_calculate[0]/(money_calculate[0]+money_calculate[4]) }}")
      }, {
        name: 'Principal',
        y: parseFloat("{{ money_calculate[2]/(money_calculate[0]+money_calculate[4]) }}")
      }, {
        name: 'Interest',
        y: parseFloat("{{ (money_calculate[4]-money_calculate[2])/(money_calculate[0]+money_calculate[4]) }}")
      }]
    }]
  });
  function calculation() {
    document.querySelector("#loan_calculation").scrollIntoView();
  }
  !function () {
    var infoWindow, map, level = 11,
      center = { lng: {{ house.lng }}, lat: {{ house.lat }}},
      features = [{ "icon": "cir", "color": "red", "name": "未命名标注", "desc": "未命名标注描述", "lnglat": { "Q": {{ house.lat }}, "R": {{ house.lng }}, "lng": {{ house.lng }}, "lat": {{ house.lat }}}, "offset": { "x": -9, "y": -31 }, "type": "Marker"}];

  function loadFeatures() {
    for (var feature, data, i = 0, len = features.length, j, jl, path; i < len; i++) {
      data = features[i];
      switch (data.type) {
        case "Marker":
          feature = new AMap.Marker({
            map: map, position: new AMap.LngLat(data.lnglat.lng, data.lnglat.lat),
            zIndex: 3, extData: data, offset: new AMap.Pixel(data.offset.x, data.offset.y), title: data.name,
            content: '<div class="icon icon-' + data.icon + ' icon-' + data.icon + '-' + data.color + '"></div>'
          });
          break;
        case "Polyline":
          for (j = 0, jl = data.path.length, path = []; j < jl; j++) {
            path.push(new AMap.LngLat(data.path[j].lng, data.path[j].lat));
          }
          feature = new AMap.Polyline({
            map: map, path: path, extData: data, zIndex: 2,
            strokeWeight: data.strokeWeight, strokeColor: data.strokeColor, strokeOpacity: data.strokeOpacity
          });
          break;
        case "Polygon":
          for (j = 0, jl = data.path.length, path = []; j < jl; j++) {
            path.push(new AMap.LngLat(data.path[j].lng, data.path[j].lat));
          }
          feature = new AMap.Polygon({
            map: map, path: path, extData: data, zIndex: 1,
            strokeWeight: data.strokeWeight, strokeColor: data.strokeColor, strokeOpacity: data.strokeOpacity,
            fillColor: data.fillColor, fillOpacity: data.fillOpacity
          });
          break;
        default: feature = null;
      }
      if (feature) { AMap.event.addListener(feature, "click", mapFeatureClick); }
    }
  }

  function mapFeatureClick(e) {
    if (!infoWindow) { infoWindow = new AMap.InfoWindow({ autoMove: true, isCustom: false }); }
    var extData = e.target.getExtData();
    infoWindow.setContent("<div class='myinfowindow'><h5>" + extData.name + "</h5><div>" + extData.desc + "</div></div>");
    infoWindow.open(map, e.lnglat);
  }

  map = new AMap.Map("mapContainer", { center: new AMap.LngLat(center.lng, center.lat), lang: "en", level: level, zoom: 15, scrollWheel: false });
  new AMap.TileLayer.RoadNet({ map: map, zIndex: 2 }); new AMap.TileLayer.Traffic({ map: map, zIndex: 3 });
  loadFeatures();

  map.on('complete', function () {
    map.plugin(["AMap.ToolBar", "AMap.OverView", "AMap.Scale"], function () {
      map.addControl(new AMap.ToolBar({ ruler: true, direction: true, locate: false })); map.addControl(new AMap.OverView({ isOpen: true })); map.addControl(new AMap.Scale);
    });
  })

}();
</script>


{% include 'footer.html' %}
{% endblock %}
